# 13 장. 더 심층적인 통찰력을 향한 리팩터링

✔ 핵심 사항: 
1. 활동의 근거지를 도메인으로 삼는다.
2. 현상과 사물을 다른 방식으로 바라보도록 노력한다.
3. 도메인 전문가와 지속적으로 대화한다.

## 시작 - ✈ 리팩토링의 시작점

**아래의 문제를 발견할 때:**

- 코드상에서 발견된 복잡성이나 부자연스러움
- 도메인 모델의 어떤 개념 누락
- 도메인 모델과의 어떤 관계 불일치 
- 도메인 전문가가 이해하지 못하는 언어
- 새로운 요구사항을 받아들이는데에 부자연스러움

## 조사팀 - 👨‍💻 개선안 조사/결정

**개선안 조사에 참여할 인원 배분 추천:**

- 관련 문제에 대한 사고 능력이 탁월한 2명의 개발자
- 도메인에 능숙하거나, 모델링 기술이 뛰어난 2명의 개발자
- (옵션) 도메인 전문가

**생산성 있는 진행에 필요한 비결:**

1. 자기 결정
   - 설계 문제를 조사하기 위한 규모가 작은 팀을 즉시 소집할 수 있어야한다.
   - 며칠 동안 작업을 진행한 후 해산한다.
   - 장기간의 정교한 조직 구조까지는 필요하지 않다.
2. 범위와 휴식
   - 며칠에 걸친 두세 번 정도의 짧은(30분 ~ 1시간 30분) 회의로 설계안을 도출해야한다. (브레인 스토밍)
   - 결정은 늦추지 않는다.
   - 진행이 막힌다면 범위를 확인하고 더 작은 영역에 집중할 수 있는지 점검한다.
3. 유비쿼터스 언어의 사용
    - 회의 과정에서 유비쿼터스 언어를 사용한다.

## 선행 기술 -  조사 내용의 출처

**다양한 출처로부터 아이디어를 흡수하고, 흡수한 아이디어와 지엽적인 지식을 결합하는 브레인 스토밍:**

- 도메인 관련 서적이나 지식
- 분석 패턴 형태로 다른 이들의 경험을 활용
- 디자인 패턴의 활용
- 수학이나 술어 로직의 정형화 활용

## 개발자를 위한 설계

**다음 두 가지를 생각하며 설계:**

1. 의도를 전달하는 유연한 설계
2. 예측 가능한 코드의 실행 과정 / 결과

## 타이밍

> 변경을 완벽하게 정당화할 수 있을 때까지 기다린다면 지나치게 오랫동안 기다린 셈이다.

**❔ 언제**

- 현재 팀에서 도메인을 이해하고 있는 바가 설계에 표현돼 있지 않은 경우
- 중요한 개념이 암시적으로 표현되어 있고, 명시적으로 표현할 방법이 보이는 경우
- 설계상의 중요한 부분을 더욱 유연하게 만들 기회가 보이는 경우

**❕ 주의사항**

- 출시전날은 하지말자
- 핵심을 찌르지 못하는, 기교를 뽐내려고 도입하지는 말자
- 도메인 전문가가 납득하지 못하면 도입하지 말자

## 위기를 기회로

> (단속 평행론) 오랜 기간 동안의 점진적인 변화나 안정성은 상대적으로 짧은 기간의 폭발적이면서 신속한 변화로 중단된다. 구 후 종은 새로운 평형 상태에 안착한다.
> 
> 개발 역시 이와 유사한 종류의 리듬을 따른다.

심층적인 통찰력을 얻다보면 불현듯 모델 내에 명백한 결점들이 드러나기 시작한다. 이런 관점에서 오히려 더 훌륭한 모델을 생각해 낼 수 있다.

---
# 4 부. 전략적 설계
: 커다란 모델을 솜씨 있게 다루고 이해하기 위한 기법<br/>
➡ 모델을 너무 크게 혹은 너무 작게 설계하여 발생하는 함정을 방지하는 체계적이고 발전하는 설계전략

4부에서는 크게 아래 세 가지 범위를 다룬다:
- 컨텍스트
- 디스틸레이션
- 대규모 구조

### 컨텍스트
: 분명하게 드러나지는 않지만, 실제로는 가장 근본적인 원칙
- 제한된 컨텍스트(BOUNDED CONTEXT)

### 디스틸레이션
: 혼란을 줄이고 적절히 주의를 집중시키는 구조
- 핵심 도메인(CORE DOMAIN)

### 대규모 구조
: 전체 그림을 완성하는 접근법
- 책임 계층 (RESPONSIBILITY LAYER)

---
# 14 장. 모델의 무결성 유지

### 단일화
: 각 용어가 모호하지 않고 모순되는 규칙이 없는 모델의 내적 일관성

ex) 용어 - _요금_ : _고객 요금_ 혹은 _공급자 요금_ 으로 사용될 여지가 있으며, 한 가지 규칙으로만 사용되는 모델의 범위는 "**단일화** 되어 있다."고 할 수있다.

❗❗ 대규모 시스템의 도메인 모델을 완전하게 단일화한다는 것은 타당하지 않거나 비용 대비 효과적이지 않다 ❗❗<br/>
⏩⏩ 단일화된 여러 모델 간의 경계와 관계를 표시해줄 수단이 필요하다.

**단일화를 유지하기 위한 기법:**
- 제한된 컨텍스트 (BOUNDED CONTEXT)
- 컨텍스트 맵 (CONTEXT MAP) 

## 제한된 컨텍스트 (BOUNDED CONTEXT)

### 컨텍스트

: 코드의 특정 부분 or 개별 팀이 수행하는 업무로, 모델은 컨텍스트에 적용된다.

### 제한된 컨텍스트

: 모델이 적용되는 컨텍스트를 명시적으로 정의하고, 특정한 규칙에 따라 설정된 컨텍스트의 경계를 설정하는 것

- 제한된 컨텍스트 경계 내에서는 단일화를 엄격하게 관리한다.
- 경계를 나누는 규칙은 대표적으로 아래와 같다:
  - 팀 조직
  - 어플리케이션의 특정 부분 (사용법, 코드 기반)
  - 데이터베이스 스키마와 같은 물리적 형태

> ✅ 제한된 컨텍스트는 모듈이 아니다:<br/>
> 제한된 컨텍스트는 단일화를 동기로하는 패턴이며, 모듈은 인지적 과부하를 동기로 하는 패턴이다. 설계에 따라 동일할 수도, 다를 수도있다.

### 제한된 컨텍스트의 균열 인식

균열의 징후:
- 코드로 작성된 인터페이스가 서로 맞지 않는 경우
- 자동화된 테스트를 이용한 지속적 통합 프로세스에서 발견
- 혼동되는 언어의 구사 (중복된 개념과 허위 동족 언어)

## 컨텍스트 맵 (CONTEXT MAP)
: 프로젝트 관리와 소프트웨어 설계 영역 사이에 걸쳐 있는 개념으로, 제한된 컨텍스트 간의 번역과 경계지점을 서술한다.

### 컨텍스트 맵 서술

1. 제한된 컨텍스트마다 이름을 부여하고, 이를 유비쿼터스 언어의 일부로 포함시킨다.
2. 제한된 컨텍스트 경계지점의 특성을 명확하게 표현한다.
   - 표현하는 방식은 시각화, 텍스트, 토론 등 다양한 형태로 나타날 수 있다.

![img.png](14%20장%20사진/img_3.png)

![img_1.png](14%20장%20사진/img_1.png)

![img_2.png](14%20장%20사진/img_2.png)

## 제한된 컨텍스트 간의 관계

두 컨텍스트 간의 연결 전략을 다룬다.
이 같은 패턴은 개발 업무를 성공적으로 조직화하기 위한 대상을 제공하고,
기존 조직을 기술하기 위한 어휘를 공급하는 역할을 한다.

### 공유 커널 (SHARED KERNEL)

![img.png](14%20장%20사진/img.png)

**목적**
- 중복을 줄인다
- 두 하위 시스템 간의 통합을 비교적 용이하게 만든다.

**특징**
- 두 팀 간에 공유하기로한 도메인의 부분집합을 명시한다.부분 집합에는 모델 요소, 연관된 코드, 데이터베이스 설계가 포함된다.
- 명시적으로 공유하는 부분들은 다른 팀과의 협의 없이는 변경하지 않는다.
- 자주 통합하고, 통합할 때는 양 팀에서 작성한 테스트를 모두 실행한다.

### 고객/공급자 개발 팀 (CUSTOMER/SUPPLIER DEVELOPMENT TEAM)

**상류 팀 / 하류 팀**

한 하위 시스템이 본질적으로 데이터를 공급하는 경우:

- 상류 컴포넌트 - 공급 컴포넌트
- 하류 컴포넌트 - 소비 컴포넌트

상류 컴포넌트와 하류 컴포넌트는 본질적으로 제한된 컨텍스트로 분리된다. 각 컴포넌트를 맡은 팀을 "상류 팀", "하류 팀" 이라 부를 수 있다.

**고객/공급자 개발 팀**

두 팀간의 명확한 고객/공급자 관계를 확립해야한다.

- 고객 : 하류팀
- 공급자 : 상류팀

하류 요구사항에 대한 작업을 고객의 입장에서의 요구사항과 동등하게 이행한다. 

- 요구사항을 함께 협상한다. 고객의 요구사항이 가장 중요하되 다른 고객의 요구사항 간에 균형을 맞춘다.
- 예산을 책정하고 일정과 약속을 이해한다.
- 검증을 위한 자동화된 인수 테스트를 개발한다.

### 준수자(CONFORMIST)

상류/하류 관계를 맺는 두 개발팀에서, 상류 팀이 하류 팀의 필요성을 충족시킬 충분한 동기를 느낄수 없는 경우 선택할 수 있는 전략이다.

하류 팀은 맹목적으로 상류 팀의 모델을 준수해서 제한된 컨텍스트 간의 번역에 따른 복잡도를 제거한다(상류 팀 컴포넌트의 단일화를 준수한다).

- 하류 팀 설계 형식이 상류 팀에 의존한다.
- 유비쿼터스 언어를 공유할 수 있고, 통합 자체는 단순해 질 수 있다.
- 상류 팀과의 의사소통을 통해 정보를 공유해야한다.